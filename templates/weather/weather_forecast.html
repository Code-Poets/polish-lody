{% extends 'polishlody/base.html' %}
{% load i18n %}
{% block title %}{% trans 'Weather forcast' %}{% endblock %}
        
{% block header_block %}
<div class="panel panel-heading panel-default">
    <center>
        <h4>{% trans 'Weather forecast' %}</h4>
    </center>
</div>
{% endblock %}

{% block body_block %}
        <!-- Usunąć z tabeli klasy table-bordered i table-striped, żeby tabela bardziej przypominała pozostałe tabelki na stronie -->

    <div class="container">
        <select name="sometext" id="day_selected">
            <option value="0" id="day0"></option>
            <option value="1" id="day1"></option>
            <option value="2" id="day2"></option>
            <option value="3" id="day3"></option>
            <option value="4" id="day4"></option>
            <option value="5" id="day5"></option>
            <option value="6" id="day6"></option>
        </select>
        <table class="table table-bordered table-hover">
            <thead>
            <tr>
                <th>{% trans 'Date' %}</th>
                <th>{% trans 'Temp ' %}[&#8451]</th>
                <th>{% trans 'Pressure ' %}[hPa]</th>
                <th>{% trans 'Humidity ' %}[%]</th>
                <th>{% trans 'Wind ' %}[km/h]</th>
                <th>{% trans 'Cloudiness ' %}[%]</th>
                <th>{% trans 'Description' %}</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script type="text/javascript">
    var weather_apixu = "https://api.apixu.com/v1/forecast.json?key=e3acfecab7234cd4b26110712172102&q=Wroclaw&days=7";
    lscache.flushExpired();
    if (localStorage.getItem('lscache-weatherData')==null) {
        $.getJSON(weather_apixu, function(data) {
            lscache.set('weatherData', data, 360);
            var localWeatherData = JSON.parse(localStorage.getItem('lscache-weatherData'));
            PopulateTableForcast();
        });
    } else {
        PopulateTableForcast();
    }
    function PopulateTableForcast() {
        var localWeatherData = JSON.parse(localStorage.getItem('lscache-weatherData'));
        var WeatherConditionsTrans = JSON.parse(sessionStorage.getItem('conditions_trans'));
        var forecast = [];
        for (var i=0; i<7; i++){
            var date = new Date(localWeatherData.forecast.forecastday[i].date_epoch*1000);
            var days_pl = ['Niedziela','Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota'];
            var days = ["{% trans 'Sunday' %}","{% trans 'Monday' %}","{% trans 'Tuesday' %}","{% trans 'Wednesday' %}","{% trans 'Thursday' %}","{% trans 'Friday' %}","{% trans 'Saturday' %}"];
            var day = days[date.getDay()];
            if(i == 0) {
                day = "{% trans 'Today' %}";
            } else if(i == 1){
                day = "{% trans 'Tomorrow' %}";
            }
            $("#day"+i).html(day);
        }
        var day_selected = $('#day_selected :selected').val();
        $.each(localWeatherData.forecast.forecastday[day_selected].hour, function(key, val){
            var temp = Math.round(val.temp_c);
            forecast.push("<tr>");
            forecast.push("<td>"+val.time+"</td>");
            forecast.push("<td>"+temp.toFixed(0)+"</td>");
            forecast.push("<td>"+(val.pressure_mb).toFixed(0)+"</td>");
            forecast.push("<td>"+(val.humidity)+"</td>");
            forecast.push("<td>"+(val.wind_kph).toFixed(0)+"</td>");
            forecast.push("<td>"+(val.cloud)+"</td>");
            if (template_lang=="pl" && sessionStorage.getItem('conditions_trans')!=null) {
                $.each(WeatherConditionsTrans, function(key2,val2){
                    if((val2.day).toLowerCase() == (val.condition.text).toLowerCase()){
                        forecast.push("<td>"+val2.languages[19].day_text+"</td>");
                    } else if ((val2.night).toLowerCase() == (val.condition.text).toLowerCase()){
                        forecast.push("<td>"+val2.languages[19].night_text+"</td>");
                    } else if (val2.code == val.condition.code){
                        forecast.push("<td>"+val2.languages[19].day_text+"</td>");
                    }
                });
            } else {
                forecast.push("<td>"+val.condition.text+"</td>");
            }
            forecast.push("</tr>");
        });
        $("table").append($(forecast.join('')));
    }

    $('#day_selected').change(function(){
        location.reload();
    });
    </script>
    
{% endblock %}